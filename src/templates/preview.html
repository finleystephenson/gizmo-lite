{% extends "base.html" %}

{% block title %}Preview - {{ deck.name }} - AI Flashcard Generator{% endblock %}

{% block content %}
<!-- Preview page displaying all generated flashcards -->
<!-- For students: This page shows all cards at once (not study mode) -->
<!-- Each card displays both question and answer for review before studying -->
<div class="max-w-4xl mx-auto">
    <h2 class="text-3xl font-bold mb-2">{{ deck.name }}</h2>
    <p id="cardCountDisplay" class="text-gray-600 mb-6"><span id="cardCount">{{ flashcards|length }}</span> flashcard<span id="cardPlural">{% if flashcards|length != 1 %}s{% endif %}</span> generated</p>

    <!-- Grid of flashcards -->
    <!-- For students: Each card is numbered and displays question/answer -->
    <!-- The "Edit" button opens a modal, the "x" button deletes the card -->
    <!-- Responsive: Single column on mobile, 2 columns on desktop (md:grid-cols-2) -->
    <div id="flashcardsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        {% for card in flashcards %}
        <div data-card-id="{{ card.id }}" class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500 relative">
            <div class="flex justify-between items-start">
                <div class="flex-1 pr-2">
                    <!-- Question (bold) -->
                    <div class="question-text font-bold text-base sm:text-lg mb-2"><span class="card-number">{{ loop.index }}</span>. {{ card.question }}</div>
                    <!-- Answer (gray text) -->
                    <div class="answer-text text-gray-700 text-sm sm:text-base">{{ card.answer }}</div>
                </div>
                <!-- Action buttons container -->
                <!-- For students: min-h/min-w ensure tappable size on mobile (44px minimum) -->
                <div class="flex items-center gap-1 sm:gap-2 ml-2">
                    <!-- Edit button -->
                    <button onclick="editCard({{ card.id }})"
                            class="text-blue-600 hover:text-blue-800 font-semibold min-h-[44px] min-w-[44px] flex items-center justify-center">
                        Edit
                    </button>
                    <!-- Delete button (red x) -->
                    <button onclick="deleteCard({{ card.id }})"
                            class="text-red-500 hover:text-red-700 font-bold text-2xl leading-none min-h-[44px] min-w-[44px] flex items-center justify-center"
                            title="Delete this flashcard">
                        &times;
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Action buttons at bottom -->
    <!-- For students: These buttons provide clear next steps -->
    <!-- Responsive: Stacks on mobile, side by side on desktop -->
    <div class="flex flex-col sm:flex-row gap-4">
        <!-- Start Studying button (Phase 4 will implement /study route) -->
        <a href="/study/{{ deck.id }}"
           class="flex-1 bg-green-600 text-white py-3 px-6 rounded-md hover:bg-green-700 transition-colors font-bold text-center min-h-[44px] flex items-center justify-center">
            Start Studying
        </a>
        <!-- Generate More Cards button returns to homepage -->
        <a href="/"
           class="flex-1 bg-gray-600 text-white py-3 px-6 rounded-md hover:bg-gray-700 transition-colors font-bold text-center min-h-[44px] flex items-center justify-center">
            Generate More Cards
        </a>
    </div>
</div>

<!-- Modal for editing flashcards -->
<div id="editModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-4 sm:p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl sm:text-2xl font-bold">Edit Flashcard</h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl min-h-[44px] min-w-[44px] flex items-center justify-center">&times;</button>
        </div>

        <form id="editForm" onsubmit="saveCard(event)">
            <input type="hidden" id="cardId" name="card_id">

            <div class="mb-4">
                <label for="question" class="block text-gray-700 font-bold mb-2">Question</label>
                <textarea id="question" name="question" rows="3" required
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>

            <div class="mb-4">
                <label for="answer" class="block text-gray-700 font-bold mb-2">Answer</label>
                <textarea id="answer" name="answer" rows="5" required
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>

            <div class="flex flex-col sm:flex-row gap-3">
                <button type="submit"
                        class="flex-1 bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 transition-colors font-bold min-h-[44px]">
                    Save Changes
                </button>
                <button type="button" onclick="closeModal()"
                        class="flex-1 border-2 border-gray-400 text-gray-600 py-2 px-6 rounded-md hover:bg-gray-100 transition-colors font-bold min-h-[44px]">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Store current flashcards data for JavaScript access
const flashcardsData = {
    {% for card in flashcards %}
    {{ card.id }}: {
        question: {{ card.question|tojson }},
        answer: {{ card.answer|tojson }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

function editCard(cardId) {
    // Load card data into modal form
    const card = flashcardsData[cardId];
    document.getElementById('cardId').value = cardId;
    document.getElementById('question').value = card.question;
    document.getElementById('answer').value = card.answer;

    // Show modal
    document.getElementById('editModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('editModal').classList.add('hidden');
}

async function saveCard(event) {
    event.preventDefault();

    const cardId = document.getElementById('cardId').value;
    const question = document.getElementById('question').value;
    const answer = document.getElementById('answer').value;

    try {
        // Send update to server
        const response = await fetch(`/card/${cardId}/edit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question, answer })
        });

        if (response.ok) {
            // Update flashcardsData cache
            flashcardsData[cardId].question = question;
            flashcardsData[cardId].answer = answer;

            // Update card display in preview list
            const cardDiv = document.querySelector(`[data-card-id="${cardId}"]`);
            cardDiv.querySelector('.question-text').textContent = question;
            cardDiv.querySelector('.answer-text').textContent = answer;

            closeModal();
        } else {
            alert('Failed to save changes. Please try again.');
        }
    } catch (error) {
        alert('Error saving changes: ' + error.message);
    }
}

// Close modal when clicking outside
document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Delete a flashcard with confirmation
async function deleteCard(cardId) {
    // Show confirmation dialog
    if (!confirm('Delete this flashcard?')) {
        return;
    }

    try {
        // Send delete request to server
        const response = await fetch(`/card/${cardId}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            // Remove card from flashcardsData cache
            delete flashcardsData[cardId];

            // Remove card element from DOM
            const cardDiv = document.querySelector(`[data-card-id="${cardId}"]`);
            cardDiv.remove();

            // Update card count display
            updateCardCount();

            // Renumber remaining cards
            renumberCards();
        } else {
            const data = await response.json();
            alert('Failed to delete card: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error deleting card: ' + error.message);
    }
}

// Update the card count display after deletion
function updateCardCount() {
    const remainingCards = document.querySelectorAll('#flashcardsGrid [data-card-id]').length;
    document.getElementById('cardCount').textContent = remainingCards;
    // Update plural (s) based on count
    document.getElementById('cardPlural').textContent = remainingCards === 1 ? '' : 's';
}

// Renumber cards after deletion to maintain sequential numbering
function renumberCards() {
    const cardNumbers = document.querySelectorAll('#flashcardsGrid .card-number');
    cardNumbers.forEach((span, index) => {
        span.textContent = index + 1;
    });
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Studying: {{ deck.name }} - AI Flashcard Generator{% endblock %}

{% block content %}
<!-- Interactive study mode - one flashcard at a time -->
<!-- For students: This page implements the classic flashcard study flow: -->
<!-- 1. See question → 2. Think about it → 3. Reveal answer → 4. Grade yourself -->
<!-- Responsive: Full width on mobile with proper padding, max-w on desktop -->
<div class="w-full max-w-3xl mx-auto px-2 sm:px-0">
    <!-- Progress indicator -->
    <!-- For students: Shows which card you're on (e.g., "Card 1 of 10") -->
    <div class="mb-6 text-center">
        <p class="text-gray-600 text-lg">
            Card <span id="currentCardNumber">1</span> of <span id="totalCards">{{ total_cards }}</span>
        </p>
        <!-- Progress bar -->
        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: {{ (1 / total_cards * 100)|round(1) }}%"></div>
        </div>
    </div>

    <!-- Flashcard display area -->
    <!-- For students: This card switches between question state and answer state -->
    <!-- JavaScript controls which state is visible -->
    <!-- Responsive: Full width on mobile with less padding, more padding on desktop -->
    <div class="bg-white rounded-lg shadow-xl p-4 sm:p-8 min-h-64 flex flex-col justify-center w-full">

        <!-- Question state (shown by default) -->
        <div id="questionState">
            <!-- Question text (large, centered) -->
            <!-- Responsive: Smaller text on mobile (text-xl vs text-2xl) -->
            <div id="questionText" class="text-xl sm:text-2xl font-bold text-center mb-6 sm:mb-8 text-gray-800"></div>

            <!-- Reveal Answer button -->
            <button onclick="revealAnswer()"
                    class="w-full bg-green-600 text-white py-3 sm:py-4 px-6 rounded-md hover:bg-green-700 transition-colors font-bold text-base sm:text-lg min-h-[44px]">
                Reveal Answer
            </button>
        </div>

        <!-- Answer state (hidden by default) -->
        <div id="answerState" class="hidden">
            <!-- Question text (smaller, at top) -->
            <!-- Responsive: Smaller text on mobile -->
            <div id="questionTextSmall" class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 text-gray-600"></div>

            <!-- Answer text (large, centered) -->
            <!-- Responsive: Smaller text and margin on mobile -->
            <div id="answerText" class="text-lg sm:text-xl text-center mb-6 sm:mb-8 text-gray-800 border-t-2 border-gray-200 pt-3 sm:pt-4"></div>

            <!-- Grading buttons -->
            <!-- For students: These buttons let you self-assess your performance -->
            <!-- Responsive: Already stacks on mobile with flex-col sm:flex-row -->
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                <button onclick="gradeCard(true)"
                        class="flex-1 bg-green-600 text-white py-3 sm:py-4 px-6 rounded-md hover:bg-green-700 transition-colors font-bold text-base sm:text-lg min-h-[44px]">
                    Got it!
                </button>
                <button onclick="gradeCard(false)"
                        class="flex-1 bg-yellow-500 text-white py-3 sm:py-4 px-6 rounded-md hover:bg-yellow-600 transition-colors font-bold text-base sm:text-lg min-h-[44px]">
                    Needs Practice
                </button>
            </div>
        </div>
    </div>

    <!-- Back to decks link -->
    <div class="mt-6 text-center">
        <a href="/decks" class="text-blue-600 hover:text-blue-800 font-semibold">
            ← Back to My Decks
        </a>
    </div>
</div>

<script>
// Store flashcards data from Jinja template
// For students: The |tojson filter converts Python data to JavaScript
// This makes the flashcards data available to our JavaScript functions
const cards = {{ flashcards|tojson }};
const totalCards = {{ total_cards }};
const deckId = {{ deck.id }};

// ============================================================================
// SPACED REPETITION: Card Queue System
// ============================================================================
// For students: This implements simple spaced repetition within a session.
// Instead of going through cards once, cards marked "Needs Practice" get
// re-queued at the end. The session only completes when ALL cards have been
// answered "Got it!" at least once.
//
// How it works:
// 1. cardQueue starts as [0, 1, 2, ..., n-1] (indices of all cards)
// 2. We always study the card at the front of the queue
// 3. "Got it!" = card mastered, remove from queue (it was already shifted)
// 4. "Needs Practice" = push the card index to the END of the queue
// 5. Session ends when queue is empty (all cards mastered)
// ============================================================================

// Initialize card queue with all card indices [0, 1, 2, ..., totalCards-1]
// For students: Array.from creates an array, then map fills it with indices
let cardQueue = Array.from({length: totalCards}, (_, i) => i);

// Track which cards have been "mastered" (answered "Got it!" at least once)
// For students: A Set is like an array but automatically prevents duplicates
const masteredCards = new Set();

// Track how many times each card has been shown (attempts per card)
// For students: Object used as a dictionary { cardId: attemptCount }
const cardAttempts = {};

// Track study results client-side (more reliable than server sessions)
// For students: We store results in JavaScript and send them all at the end
// Note: This now tracks ALL attempts, including re-queued cards
const studyResults = [];

// Track total cards shown (for progress display purposes)
let cardsShown = 0;

// Initialize the first card on page load
// For students: This function runs when the page loads
// It displays the first flashcard's question
function init() {
    displayCard();
}

// Display the current card in question state
// For students: This function updates the DOM with the current card's question
// It resets to question state (answer hidden) for each new card
function displayCard() {
    // Get card index from FRONT of queue (peek, don't remove yet)
    // For students: cardQueue[0] is the first element in the array
    const cardIndex = cardQueue[0];
    const card = cards[cardIndex];

    // Track attempt for this card
    // For students: Increment the attempt counter each time card is shown
    cardAttempts[card.id] = (cardAttempts[card.id] || 0) + 1;
    cardsShown++;

    // Update progress indicator to show queue status
    // For students: We show how many cards remain to master, not linear progress
    const masteredCount = masteredCards.size;
    const remainingCount = cardQueue.length;
    document.getElementById('currentCardNumber').textContent = masteredCount + 1;
    document.getElementById('totalCards').textContent = totalCards;

    // Progress bar shows percentage of cards MASTERED (not just seen)
    const progressPercent = ((masteredCount / totalCards) * 100).toFixed(1);
    document.getElementById('progressBar').style.width = progressPercent + '%';

    // Show question text in both places (large for question state, small for answer state)
    document.getElementById('questionText').textContent = card.question;
    document.getElementById('questionTextSmall').textContent = card.question;

    // Show answer text (for when we reveal it)
    document.getElementById('answerText').textContent = card.answer;

    // Reset to question state (hide answer)
    document.getElementById('questionState').classList.remove('hidden');
    document.getElementById('answerState').classList.add('hidden');
}

// Reveal the answer for the current card
// For students: This function toggles from question state to answer state
// It's triggered when the user clicks "Reveal Answer"
function revealAnswer() {
    // Hide question state, show answer state
    document.getElementById('questionState').classList.add('hidden');
    document.getElementById('answerState').classList.remove('hidden');
}

// Grade the current card and move to next
// For students: This function does three things:
// 1. Sends the grade to the server (POST to /study/{deck_id}/grade)
// 2. Updates the card queue based on grade (re-queue if "Needs Practice")
// 3. Either displays the next card or redirects to summary if done
async function gradeCard(success) {
    // Remove card from FRONT of queue (we already displayed it)
    // For students: shift() removes and returns the first element
    const cardIndex = cardQueue.shift();
    const card = cards[cardIndex];

    try {
        // Send grade to server to update database statistics
        // For students: fetch() makes an AJAX request without page reload
        // Each attempt is recorded in the database (studied_count increments)
        const response = await fetch(`/study/${deckId}/grade`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                card_id: card.id,
                success: success
            })
        });

        if (!response.ok) {
            // Put card back if save failed
            cardQueue.unshift(cardIndex);
            alert('Failed to save grade. Please try again.');
            return;
        }

        // Track result client-side for final summary
        // For students: Every attempt is logged for the summary page
        studyResults.push({
            card_id: card.id,
            question: card.question,
            success: success
        });

        // ============================================================
        // SPACED REPETITION LOGIC
        // ============================================================
        // For students: This is where the magic happens!
        // - "Got it!" = mark as mastered (won't see again this session)
        // - "Needs Practice" = re-queue at the END (will see again later)
        // ============================================================
        if (success) {
            // Card mastered! Add to mastered set
            // For students: Set.add() is idempotent - adding twice is fine
            masteredCards.add(card.id);
            console.log(`Card "${card.question.substring(0, 30)}..." mastered! (${masteredCards.size}/${totalCards})`);
        } else {
            // Needs practice - re-queue at the END of the queue
            // For students: push() adds to the end of the array
            // This card will appear again after all other pending cards
            cardQueue.push(cardIndex);
            console.log(`Card "${card.question.substring(0, 30)}..." re-queued. Queue length: ${cardQueue.length}`);
        }

        // Check if session is complete (queue is empty = all cards mastered)
        // For students: When queue is empty, every card has been answered "Got it!"
        if (cardQueue.length === 0) {
            // Calculate total attempts for summary
            const totalAttempts = Object.values(cardAttempts).reduce((sum, count) => sum + count, 0);

            // Submit all results and redirect to summary page
            // For students: We POST all results at once, including attempt count
            const summaryResponse = await fetch(`/study/${deckId}/summary`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    results: studyResults,
                    total_attempts: totalAttempts,
                    cards_mastered: totalCards
                })
            });

            if (summaryResponse.ok) {
                // Redirect to the summary page (GET request to display it)
                window.location.href = `/study/${deckId}/summary`;
            } else {
                alert('Failed to save session results.');
            }
        } else {
            // Display next card from the queue
            displayCard();
        }

    } catch (error) {
        // Put card back if there was an error
        cardQueue.unshift(cardIndex);
        alert('Error saving grade: ' + error.message);
    }
}

// Initialize on page load
// For students: This runs as soon as the page loads
init();
</script>
{% endblock %}

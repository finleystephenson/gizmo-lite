---
phase: 04-study-mode-ui
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified: [src/templates/summary.html, src/routes/main.py]
autonomous: false
---

<objective>
Create session end summary showing study performance statistics.

Purpose: After completing a deck, users see their performance (cards studied, success rate) and can choose to study again or return to deck selection.
Output: Working summary page with session statistics and navigation options.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work in this phase
@.planning/phases/04-study-mode-ui/04-01-SUMMARY.md
@.planning/phases/04-study-mode-ui/04-02-SUMMARY.md

# Templates for design patterns
@src/templates/preview.html
@src/templates/base.html

# Routes for session data
@src/routes/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session summary template</name>
  <files>src/templates/summary.html</files>
  <action>
Create summary.html template extending base.html to display study session results:

**Structure:**
- Extend base.html
- Title: "Session Complete - {{ deck.name }}"
- Congratulations message: "Great work! You've completed this deck."

**Statistics display:**
Show performance metrics in a clean card layout:
- Total cards studied: {{ total_cards }}
- Cards marked "Got it": {{ success_count }} (in green)
- Cards needing practice: {{ needs_practice_count }} (in yellow)
- Success rate: {{ success_rate }}% (calculated as success_count / total_cards * 100)

**List of cards needing practice:**
If needs_practice_count > 0:
- Section heading: "Cards to review:"
- List of questions from cards marked "Needs Practice"
- Small, subtle styling (not overwhelming)

If needs_practice_count == 0:
- Celebration message: "Perfect score! You got everything right! ðŸŽ‰"

**Action buttons:**
Two buttons at bottom:
- "Study Again" (green) â†’ links to /study/{{ deck.id }}
- "Back to My Decks" (gray) â†’ links to /decks

**Styling:**
- Use Tailwind classes matching existing templates
- Statistics in a grid (md:grid-cols-2 for desktop, single column mobile)
- Cards with bg-white rounded-lg shadow border-l-4
- Success stats: border-green-500, Needs practice: border-yellow-500
- Center content, max-w-4xl mx-auto

Add educational comments explaining session summary purpose.
  </action>
  <verify>
Template file exists with valid Jinja2 syntax. Structure includes stats display, practice list conditional, and action buttons.
  </verify>
  <done>
summary.html template created showing session statistics, cards needing practice, and navigation options.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add /study/{deck_id}/summary route</name>
  <files>src/routes/main.py</files>
  <action>
Add session summary route in src/routes/main.py:

**Route:** @main.route('/study/<int:deck_id>/summary')
**Function:** study_summary(deck_id)
**Logic:**
1. Validate deck_id matches session['studying_deck_id']
2. Load deck using Deck.get_by_id(deck_id)
3. Get session results from session['cards_studied'] (list of {card_id, success} dicts)
4. Calculate statistics:
   - total_cards = len(session['cards_studied'])
   - success_count = count of cards where success=True
   - needs_practice_count = count of cards where success=False
   - success_rate = round((success_count / total_cards) * 100, 1) if total_cards > 0 else 0

5. Get cards needing practice:
   - Filter session['cards_studied'] for success=False
   - Load full flashcard data for those card_ids using Flashcard model
   - Extract just the questions for display

6. Clear session study data:
   ```python
   session.pop('studying_deck_id', None)
   session.pop('cards_studied', None)
   ```

7. Render summary.html with:
   - deck
   - total_cards
   - success_count
   - needs_practice_count
   - success_rate
   - practice_questions (list of question strings)

**Error handling:**
- If no session['studying_deck_id']: redirect to /decks
- If deck not found: return 404
- If session['cards_studied'] is empty: redirect to /study/{deck_id}

Add docstring: "Display session summary with performance statistics and cards needing practice"
Add educational comments explaining session cleanup.
  </action>
  <verify>
Complete a study session, verify redirect to summary page.
Summary shows correct statistics matching session data.
Session data cleared after viewing summary.
  </verify>
  <done>
/study/{deck_id}/summary route implemented showing session performance and cleaning up session data.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update study.html to redirect to summary after last card</name>
  <files>src/templates/study.html</files>
  <action>
Modify the JavaScript in study.html to handle session completion:

In the `gradeCard(success)` function, after POSTing the grade:
- Check if current card is the last card: `currentIndex >= cards.length - 1`
- If last card: `window.location.href = '/study/{{ deck.id }}/summary';`
- If not last card: increment currentIndex and load next card

**Updated gradeCard function:**
```javascript
async function gradeCard(success) {
    const card = cards[currentIndex];

    // Submit grade
    await fetch('/study/{{ deck.id }}/grade', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({card_id: card.id, success: success})
    });

    // Check if last card
    if (currentIndex >= cards.length - 1) {
        // Session complete - redirect to summary
        window.location.href = '/study/{{ deck.id }}/summary';
        return;
    }

    // Move to next card
    currentIndex++;
    loadCard();
}
```

Add comment explaining why we check for last card and redirect to summary.
  </action>
  <verify>
Study through all cards in a deck - after last card graded, automatically redirects to summary page.
  </verify>
  <done>
study.html updated to redirect to summary page after last card is graded.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete study session flow with performance summary</what-built>
  <how-to-verify>
1. Run Flask: `FLASK_APP=src.app flask run`
2. Visit http://localhost:5001/decks
3. Click "Study Now" on any deck
4. Study through all cards:
   - Click "Reveal Answer" on each
   - Mix of "Got it!" and "Needs Practice" responses (e.g., first 2 "Got it", next 1 "Needs Practice")
5. After last card graded:
   - Automatically redirects to summary page
   - Summary shows:
     - Deck name at top
     - Total cards studied (correct count)
     - Success count (cards marked "Got it")
     - Needs practice count (cards marked "Needs Practice")
     - Success rate percentage (calculated correctly)
   - If you marked some as "Needs Practice":
     - Section shows "Cards to review:"
     - Lists the questions you marked as needing practice
   - If you marked all as "Got it":
     - Shows celebration message "Perfect score!"
6. Click "Study Again" â†’ returns to /study/{deck_id} to restart
7. Complete session again, click "Back to My Decks" â†’ returns to /decks
8. Try studying a different deck - no data contamination from previous session

**What to confirm:**
- Statistics calculate correctly
- Cards needing practice list is accurate
- Perfect score shows celebration message
- Navigation buttons work
- Session data doesn't leak between decks
- Overall flow feels smooth and educational
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Flask app runs without errors
- [ ] Summary page displays after completing study session
- [ ] Statistics calculate correctly (total, success count, rate)
- [ ] Cards needing practice list shows correct questions
- [ ] Perfect score shows celebration message
- [ ] "Study Again" and "Back to My Decks" buttons work
- [ ] Session data clears after summary
- [ ] Human verification passed
</verification>

<success_criteria>

- All tasks completed
- Session summary functional with accurate statistics
- Cards needing practice displayed correctly
- Navigation options work
- Session cleanup prevents data leaks
- User approved complete study flow
  </success_criteria>

<output>
After completion, create `.planning/phases/04-study-mode-ui/04-03-SUMMARY.md`
</output>

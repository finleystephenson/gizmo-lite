---
phase: 04-study-mode-ui
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: [src/templates/study.html, src/routes/main.py]
autonomous: false
---

<objective>
Implement interactive study mode showing one flashcard at a time with reveal and self-grading.

Purpose: Core study experience where users learn from flashcards by seeing question, thinking, revealing answer, and self-grading their performance.
Output: Working study interface with question/answer reveal flow and "Got it"/"Needs Practice" buttons.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work in this phase
@.planning/phases/04-study-mode-ui/04-01-SUMMARY.md

# Phase 3 templates for design patterns
@src/templates/preview.html
@src/templates/base.html

# Models for data access
@src/models/flashcard.py
@src/models/deck.py
@src/routes/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create study mode template with flashcard UI</name>
  <files>src/templates/study.html</files>
  <action>
Create study.html template extending base.html with interactive flashcard study interface:

**Structure:**
- Extend base.html
- Title: "Studying: {{ deck.name }}"
- Progress indicator: "Card {{ current_index + 1 }} of {{ total_cards }}"
- Large card div (min-height-64) with two states controlled by JavaScript:

  **Question state (default):**
  - Show question text (large, bold, centered)
  - "Reveal Answer" button (prominent, green)

  **Answer state (after reveal):**
  - Show question text (smaller, at top)
  - Show answer text (large, centered)
  - Two buttons side-by-side:
    - "Got it!" (green, submits success=true)
    - "Needs Practice" (yellow, submits success=false)

**JavaScript functionality:**
- Store flashcards data from Jinja: `const cards = {{ flashcards|tojson }};`
- Track current card index
- `revealAnswer()` function: toggle from question to answer state
- `gradeCard(success)` function:
  - POST to /study/{{ deck.id }}/grade with card_id and success
  - Move to next card (increment index)
  - If last card, redirect to /study/{{ deck.id }}/summary

**Styling:**
- Use Tailwind classes matching preview.html style
- Card div: bg-white rounded-lg shadow-xl p-8
- Center content vertically and horizontally
- Large, readable text (text-2xl for question, text-xl for answer)
- Buttons: full-width on mobile, side-by-side on desktop

Add educational comments explaining the reveal pattern and why we track index client-side.
  </action>
  <verify>
Template file exists with valid Jinja2 syntax. HTML structure includes question/answer states and JavaScript functions.
  </verify>
  <done>
study.html template created with interactive flashcard UI, reveal button, grading buttons, and progress indicator.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add /study/{deck_id} route to load flashcards</name>
  <files>src/routes/main.py</files>
  <action>
Add study session route in src/routes/main.py:

**Route:** @main.route('/study/<int:deck_id>')
**Function:** study(deck_id)
**Logic:**
1. Load deck using Deck.get_by_id(deck_id)
2. If deck not found, return 404 error
3. Load all flashcards using Flashcard.get_by_deck(deck_id)
4. If no flashcards in deck, show error: "This deck has no flashcards"
5. Render study.html with:
   - deck (dict with name, id)
   - flashcards (list of all cards with id, question, answer)
   - total_cards (length of flashcards list)

**Session state:**
Store deck_id in Flask session for grade tracking later:
```python
from flask import session
session['studying_deck_id'] = deck_id
session['cards_studied'] = []  # Will track card results
```

Add docstring: "Start study session for a deck - loads all flashcards and initializes session tracking"
Add educational comments explaining session usage.
  </action>
  <verify>
Visit /study/1 (with valid deck_id) → renders study page with first card.
Visit /study/999 (invalid deck_id) → returns 404.
  </verify>
  <done>
/study/{deck_id} route implemented loading deck and flashcards for study session.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add /study/{deck_id}/grade endpoint for card grading</name>
  <files>src/routes/main.py</files>
  <action>
Add card grading endpoint in src/routes/main.py:

**Route:** @main.route('/study/<int:deck_id>/grade', methods=['POST'])
**Function:** grade_card(deck_id)
**Logic:**
1. Get JSON data: card_id and success (boolean) from request.get_json()
2. Validate deck_id matches session['studying_deck_id']
3. Update flashcard statistics using Flashcard.update_stats(card_id, success)
4. Track in session: session['cards_studied'].append({'card_id': card_id, 'success': success})
5. Return JSON: {'success': True}

**Error handling:**
- If no JSON data: return 400 with error message
- If card_id or success missing: return 400
- If deck_id mismatch: return 403 "Invalid session"
- If Flashcard.update_stats fails: return 500

Add docstring: "Grade a flashcard during study session and update statistics"
Add educational comments explaining why we validate session state.

Import session from flask if not already imported: `from flask import session`
  </action>
  <verify>
Curl test: `curl -X POST http://localhost:5001/study/1/grade -H "Content-Type: application/json" -d '{"card_id":1,"success":true}'` returns 200 with success:true
Database updated: Check flashcard studied_count incremented.
  </verify>
  <done>
/study/{deck_id}/grade endpoint implemented updating flashcard statistics.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Interactive study mode with flashcard reveal and self-grading</what-built>
  <how-to-verify>
1. Run Flask: `FLASK_APP=src.app flask run`
2. Visit http://localhost:5001/decks
3. Click "Study Now" on any deck
4. Study session should load:
   - Shows "Card 1 of X" progress indicator
   - Shows question text (large, centered)
   - Shows "Reveal Answer" button
5. Click "Reveal Answer":
   - Question moves to top (smaller)
   - Answer appears (large, centered)
   - "Got it!" and "Needs Practice" buttons appear
6. Click "Got it!" (or "Needs Practice"):
   - Next card loads automatically
   - Progress updates to "Card 2 of X"
   - Back to question state
7. Continue through all cards - last card should redirect to summary (summary page doesn't exist yet, that's expected - will show 404 for now)
8. Check database: Run `sqlite3 flashcards.db "SELECT studied_count, success_count FROM flashcards LIMIT 3"` - counts should have incremented

**What to confirm:**
- Reveal flow works smoothly (question → answer transition)
- Grading buttons register (card advances)
- Progress indicator updates correctly
- No JavaScript errors in browser console
- Database statistics updating
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Flask app runs without errors
- [ ] /study/{deck_id} route loads and shows first flashcard
- [ ] "Reveal Answer" button toggles to answer state
- [ ] "Got it!" and "Needs Practice" buttons work
- [ ] Card advances to next after grading
- [ ] Progress indicator updates
- [ ] Statistics update in database
- [ ] Human verification passed
</verification>

<success_criteria>

- All tasks completed
- Study mode functional with reveal and grading flow
- Statistics tracking works (studied_count, success_count increment)
- Session state properly managed
- User approved functionality in checkpoint
  </success_criteria>

<output>
After completion, create `.planning/phases/04-study-mode-ui/04-02-SUMMARY.md`
</output>

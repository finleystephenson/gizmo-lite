---
phase: 03-card-generation-ui
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/routes/main.py (modify)
  - src/templates/preview.html (create)
  - src/templates/loading.html (create)
autonomous: false
---

<objective>
Implement flashcard generation endpoint and preview page with loading state.

Purpose: Connect form submission to AI service and display generated cards
Output: Working generation flow from notes input to card preview
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-card-generation-ui/03-01-SUMMARY.md

**From Phase 2:**
- FlashcardGenerator service exists with `generate_and_save()` method
- Method takes (notes: str, topic: str) and returns dict with deck_id, topic, flashcard_count
- Handles API errors with exponential backoff automatically
- Persists to database atomically (Deck + 10 Flashcards)

**From Plan 03-01:**
- Homepage form submits POST to /generate with notes and topic
- Base template and Tailwind CSS available
- Blueprint registered in app

**Phase 3 Requirements:**
- Loading state while generating (API can take 5-15 seconds)
- Display 10 generated cards in preview list
- Show question and answer for each card

@src/services/flashcard_generator.py
@src/models/deck.py
@src/models/flashcard.py
@src/routes/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generation endpoint with loading state</name>
  <files>src/routes/main.py, src/templates/loading.html</files>
  <action>
**Step 1: Add POST /generate route in src/routes/main.py:**

```python
from flask import render_template, request, redirect, url_for
from src.services.flashcard_generator import FlashcardGenerator

@main.route('/generate', methods=['POST'])
def generate():
    """Generate flashcards from study notes using AI."""
    # Get form data
    notes = request.form.get('notes')
    topic = request.form.get('topic')

    # Validate inputs
    if not notes or not topic:
        return "Missing notes or topic", 400

    try:
        # Generate and save flashcards
        generator = FlashcardGenerator()
        result = generator.generate_and_save(notes, topic)

        # Redirect to preview page with deck_id
        return redirect(url_for('main.preview', deck_id=result['deck_id']))

    except ValueError as e:
        # API errors return ValueError with user-friendly messages
        return render_template('error.html', error=str(e)), 500
```

**Step 2: Create loading template (src/templates/loading.html):**
- Extend base.html
- Show loading spinner (Tailwind animated spinner)
- Message: "Generating your flashcards... This may take 10-20 seconds."
- Include JavaScript to submit form and show loading overlay

**Note on loading UX:**
The generation happens synchronously in the POST handler. While not ideal for production, this keeps the student project simple (no JavaScript fetch, no async complexity). The browser's native loading indicator is sufficient for the student learning context.

**Error template (src/templates/error.html):**
Simple error page showing the error message with a link back to homepage.

**Why this approach:**
- Synchronous keeps code simple for student
- Flask handles form submission natively
- Errors from Phase 2 (API rate limits, etc.) propagate with user-friendly messages
- Redirect to preview page after success (RESTful pattern)
  </action>
  <verify>
1. Submit form from homepage
2. Generation completes (may take 10-20 seconds with API call)
3. Redirects to /preview/<deck_id> (created in next task)
4. Error cases return error page with message
  </verify>
  <done>POST /generate endpoint works, calls FlashcardGenerator service, redirects to preview</done>
</task>

<task type="auto">
  <name>Task 2: Create preview page with card list</name>
  <files>src/routes/main.py, src/templates/preview.html</files>
  <action>
**Step 1: Add GET /preview/<deck_id> route in src/routes/main.py:**

```python
from src.models.deck import Deck
from src.models.flashcard import Flashcard

@main.route('/preview/<int:deck_id>')
def preview(deck_id):
    """Preview generated flashcards before study."""
    # Load deck and flashcards from database
    deck = Deck.get_by_id(deck_id)
    if not deck:
        return "Deck not found", 404

    flashcards = Flashcard.get_by_deck(deck_id)

    return render_template('preview.html', deck=deck, flashcards=flashcards)
```

**Step 2: Create preview template (src/templates/preview.html):**
- Extend base.html
- Display deck topic name at top
- List all 10 flashcards in numbered grid (1-10)
- Each card shows:
  - Question (bold)
  - Answer (regular text, gray)
  - "Edit" button (opens modal in next plan)
- Add "Start Studying" button at bottom (links to study mode - Phase 4)
- Add "Generate More Cards" button (returns to homepage)

**Card list design:**
```html
<div class="max-w-4xl mx-auto">
    <h2 class="text-3xl font-bold mb-6">{{ deck.name }}</h2>
    <p class="text-gray-600 mb-4">{{ flashcards|length }} flashcards generated</p>

    <div class="grid gap-4 mb-8">
        {% for card in flashcards %}
        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="font-bold text-lg mb-2">{{ loop.index }}. {{ card.question }}</div>
                    <div class="text-gray-700">{{ card.answer }}</div>
                </div>
                <button onclick="editCard({{ card.id }})"
                        class="ml-4 text-blue-600 hover:text-blue-800">
                    Edit
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="flex gap-4">
        <a href="/study/{{ deck.id }}"
           class="flex-1 bg-green-600 text-white py-3 px-6 rounded-md hover:bg-green-700 transition-colors font-bold text-center">
            Start Studying
        </a>
        <a href="/"
           class="flex-1 bg-gray-600 text-white py-3 px-6 rounded-md hover:bg-gray-700 transition-colors font-bold text-center">
            Generate More Cards
        </a>
    </div>
</div>
```

**Note:** Edit button calls `editCard()` JavaScript function (created in Plan 03-03). Study link goes to /study/<deck_id> (Phase 4 will implement).

**Why this design:**
- Grid layout cleanly displays all 10 cards
- Question/answer both visible (preview mode, not study mode)
- Numbered list helps users scan all cards
- Clear action buttons guide next steps
  </action>
  <verify>
1. After generation completes, preview page displays
2. Deck topic shown at top
3. All 10 cards displayed in numbered list
4. Each card shows question and answer
5. "Start Studying" and "Generate More Cards" buttons visible
  </verify>
  <done>Preview page displays deck name and all generated flashcards with edit buttons</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete flashcard generation flow from homepage form to preview page with 10 AI-generated cards</what-built>
  <how-to-verify>
    1. Run: `flask run`
    2. Visit: http://localhost:5000
    3. Enter topic: "Flask Basics"
    4. Enter notes: "Flask is a micro web framework. Routes use @app.route decorator. render_template displays HTML templates."
    5. Click "Generate Flashcards" (wait 10-20 seconds for API)
    6. Verify: Preview page displays with deck topic
    7. Verify: 10 flashcards shown, each with question and answer
    8. Verify: Questions test understanding (not yes/no)
    9. Verify: Answers are detailed
    10. Verify: "Edit" buttons visible on each card
    11. Verify: "Start Studying" and "Generate More Cards" buttons present
    12. Test: Click "Generate More Cards" - returns to homepage
    13. Test: Create another deck with different topic - confirm works
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] POST /generate endpoint works and calls FlashcardGenerator
- [ ] Preview page displays deck and all flashcards
- [ ] Generated cards test understanding (educational quality)
- [ ] User confirms UI looks good and flow works
</verification>

<success_criteria>

- Generation endpoint integrates with FlashcardGenerator service
- Preview page displays all generated flashcards
- Loading/error states handled appropriately
- User verification checkpoint passed
- Clean, functional UI with Tailwind styling
- 2 task commits + 1 checkpoint approval
  </success_criteria>

<output>
After completion, create `.planning/phases/03-card-generation-ui/03-02-SUMMARY.md`
</output>

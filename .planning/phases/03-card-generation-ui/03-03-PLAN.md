---
phase: 03-card-generation-ui
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/templates/preview.html (modify)
  - src/routes/main.py (modify)
autonomous: false
---

<objective>
Add modal popup card editor with save functionality.

Purpose: Allow users to edit AI-generated flashcards before studying
Output: Working modal editor that updates cards in database
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-card-generation-ui/03-02-SUMMARY.md

**From STATE.md decision:**
- Modal popup for card editing (cleaner separation between preview and edit modes)
- Student-friendly code with explanations

**From Plan 03-02:**
- Preview page displays all flashcards with "Edit" buttons
- Each card has id available: `{{ card.id }}`
- Edit buttons call `editCard(cardId)` JavaScript function (to be implemented)

**From Phase 1:**
- Flashcard model has update() method (inherited from Phase 1 database work)
- update(card_id, question=None, answer=None) updates specific fields

**Phase 3 Goal:**
- Modal popup for editing
- Save changes to database
- Update UI without full page reload

@src/models/flashcard.py
@src/templates/preview.html
@src/routes/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add modal popup component with JavaScript</name>
  <files>src/templates/preview.html</files>
  <action>
**Add modal HTML to bottom of preview.html (before </body>):**

```html
<!-- Modal for editing flashcards -->
<div id="editModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold">Edit Flashcard</h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>

        <form id="editForm" onsubmit="saveCard(event)">
            <input type="hidden" id="cardId" name="card_id">

            <div class="mb-4">
                <label for="question" class="block text-gray-700 font-bold mb-2">Question</label>
                <textarea id="question" name="question" rows="3" required
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>

            <div class="mb-4">
                <label for="answer" class="block text-gray-700 font-bold mb-2">Answer</label>
                <textarea id="answer" name="answer" rows="5" required
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>

            <div class="flex gap-3">
                <button type="submit"
                        class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors font-bold">
                    Save Changes
                </button>
                <button type="button" onclick="closeModal()"
                        class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition-colors font-bold">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Store current flashcards data for JavaScript access
const flashcardsData = {
    {% for card in flashcards %}
    {{ card.id }}: {
        question: {{ card.question|tojson }},
        answer: {{ card.answer|tojson }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

function editCard(cardId) {
    // Load card data into modal form
    const card = flashcardsData[cardId];
    document.getElementById('cardId').value = cardId;
    document.getElementById('question').value = card.question;
    document.getElementById('answer').value = card.answer;

    // Show modal
    document.getElementById('editModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('editModal').classList.add('hidden');
}

async function saveCard(event) {
    event.preventDefault();

    const cardId = document.getElementById('cardId').value;
    const question = document.getElementById('question').value;
    const answer = document.getElementById('answer').value;

    try {
        // Send update to server
        const response = await fetch(`/card/${cardId}/edit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question, answer })
        });

        if (response.ok) {
            // Update flashcardsData cache
            flashcardsData[cardId].question = question;
            flashcardsData[cardId].answer = answer;

            // Update card display in preview list
            const cardDiv = document.querySelector(`[data-card-id="${cardId}"]`);
            cardDiv.querySelector('.question-text').textContent = question;
            cardDiv.querySelector('.answer-text').textContent = answer;

            closeModal();
        } else {
            alert('Failed to save changes. Please try again.');
        }
    } catch (error) {
        alert('Error saving changes: ' + error.message);
    }
}

// Close modal when clicking outside
document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
```

**Update card display HTML to include data attributes:**
Change the card div to:
```html
<div data-card-id="{{ card.id }}" class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
    <div class="flex justify-between items-start">
        <div class="flex-1">
            <div class="question-text font-bold text-lg mb-2">{{ loop.index }}. {{ card.question }}</div>
            <div class="answer-text text-gray-700">{{ card.answer }}</div>
        </div>
        <button onclick="editCard({{ card.id }})" class="ml-4 text-blue-600 hover:text-blue-800">
            Edit
        </button>
    </div>
</div>
```

**Why this approach:**
- Modal overlay provides clean edit UX (matches user preference)
- JavaScript handles modal show/hide (no page reload)
- Fetch API updates server without navigation
- Updates UI immediately after save (optimistic update pattern)
- Jinja2 tojson filter safely escapes strings for JavaScript
- Student sees modern web patterns (fetch, async/await, DOM updates)
  </action>
  <verify>
1. Click "Edit" button on any card
2. Modal opens with card's question and answer pre-filled
3. Modal can be closed with X button or clicking outside
4. Save button ready to submit (endpoint created in next task)
  </verify>
  <done>Modal popup displays with edit form, opens/closes correctly, ready for save endpoint</done>
</task>

<task type="auto">
  <name>Task 2: Add edit endpoint to save changes</name>
  <files>src/routes/main.py</files>
  <action>
**Add POST /card/<card_id>/edit route in src/routes/main.py:**

```python
from flask import jsonify
from src.models.flashcard import Flashcard

@main.route('/card/<int:card_id>/edit', methods=['POST'])
def edit_card(card_id):
    """Update flashcard question and answer."""
    # Get JSON data from request
    data = request.get_json()

    if not data:
        return jsonify({'error': 'No data provided'}), 400

    question = data.get('question')
    answer = data.get('answer')

    # Validate inputs
    if not question or not answer:
        return jsonify({'error': 'Question and answer are required'}), 400

    # Update card in database
    try:
        Flashcard.update(card_id, question=question, answer=answer)
        return jsonify({'success': True}), 200
    except Exception as e:
        return jsonify({'error': str(e)}), 500
```

**Why this approach:**
- RESTful endpoint: POST /card/<id>/edit
- Accepts JSON payload (modern API pattern)
- Returns JSON response (matches fetch expectations)
- Uses Flashcard.update() from Phase 1 database models
- Simple error handling with appropriate HTTP status codes

**Student learning:**
- JSON API endpoints (common in modern web apps)
- RESTful resource naming (POST /card/<id>/edit)
- Status code meanings (200 success, 400 bad request, 500 server error)
- JavaScript fetch + backend integration
  </action>
  <verify>
1. Open modal and edit a flashcard
2. Change question text
3. Change answer text
4. Click "Save Changes"
5. Modal closes
6. Card updates in preview list without page reload
7. Refresh page - changes persisted in database
  </verify>
  <done>Edit endpoint works, updates database, returns JSON response to JavaScript</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Modal card editor with database persistence and live UI updates</what-built>
  <how-to-verify>
    1. Run: `flask run`
    2. Visit: http://localhost:5000 and generate a deck (or use existing deck from previous test)
    3. On preview page, click "Edit" on first flashcard
    4. Verify: Modal opens with question and answer pre-filled
    5. Edit: Change question to "What is Flask? (edited)"
    6. Edit: Change answer to "Flask is a Python micro web framework. (edited)"
    7. Click "Save Changes"
    8. Verify: Modal closes immediately
    9. Verify: Card #1 now shows edited question and answer (no page reload)
    10. Test: Click "Edit" on card #1 again - verify edited text appears in modal
    11. Test: Click outside modal (gray overlay) - modal closes
    12. Test: Click X button - modal closes
    13. Test: Edit another card (e.g., card #5) - verify works independently
    14. Refresh page (F5)
    15. Verify: Edited cards still show edited content (persisted to database)
    16. Verify: UI is clean, responsive, buttons work smoothly
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Modal opens/closes correctly
- [ ] Edit form pre-fills with card data
- [ ] Save endpoint updates database
- [ ] UI updates without page reload
- [ ] Changes persist after refresh
- [ ] User verification passed
</verification>

<success_criteria>

- Modal popup editor functional
- Edit endpoint saves to database
- JavaScript updates UI without reload
- All interactions work smoothly
- User verification checkpoint passed
- Clean modal UX matches design preference
- 2 task commits + 1 checkpoint approval
  </success_criteria>

<output>
After completion, create `.planning/phases/03-card-generation-ui/03-03-SUMMARY.md`
</output>

---
phase: 02-ai-integration
plan: 01
type: feature
wave: 1-2
depends_on: [01-03]
files_modified:
  - src/models/schemas.py (create)
  - src/services/__init__.py (create)
  - src/services/flashcard_generator.py (create)
autonomous: false
---

# Plan 02-01: Core AI Service with Structured Outputs

## Objective

Create the core FlashcardGenerator service using Anthropic's structured outputs feature to reliably generate 10 Q&A flashcard pairs from study notes.

## Execution Context

**From Phase 1:**
- Config class loads ANTHROPIC_API_KEY from environment (src/config.py)
- Database models ready: Deck and Flashcard with CRUD operations
- Project uses src/ directory structure with proper Python package imports

**From Research (02-RESEARCH.md):**
- Use Anthropic structured outputs (beta feature, Nov 2025)
- Requires beta header: `anthropic-beta: structured-outputs-2025-11-13`
- Use `client.beta.messages.parse()` with Pydantic models for type-safe responses
- Recommended model: Claude Sonnet 4.5 (balance of quality and cost)
- Set max_tokens=2048+ for 10 flashcards generation
- Prompt engineering: explicit instructions for active recall, educational quality

**Research Key Findings:**
- Don't hand-roll JSON parsing - structured outputs guarantee 100% schema compliance
- Don't hand-roll auth headers - SDK handles automatically
- Define Pydantic models, get guaranteed valid JSON back
- Prompt should emphasize: active recall, avoid yes/no questions, test understanding not memorization

## Context

**Wave 1: Pydantic Schema Definition**

We'll create Pydantic models that define the exact structure we want from Claude. This uses the structured outputs feature to guarantee JSON schema compliance.

Schema structure:
- `FlashcardPair`: Single Q&A pair (question: str, answer: str)
- `FlashcardSet`: Collection of 10 pairs (flashcards: List[FlashcardPair], metadata like topic)

**Wave 2: FlashcardGenerator Service**

Core service class that:
1. Initializes Anthropic client with API key from config
2. Constructs educational prompt emphasizing active recall
3. Calls `client.beta.messages.parse()` with Pydantic schema
4. Returns structured FlashcardSet with guaranteed 10 Q&A pairs

**Educational Focus:**

The prompt must guide Claude to:
- Generate questions that test understanding, not memorization
- Avoid yes/no questions - prefer "explain", "describe", "why"
- Focus on key concepts from the notes
- Create answers that reinforce learning (not just facts)

**Files to Create:**
1. `src/models/schemas.py` - Pydantic models for API response
2. `src/services/__init__.py` - Services package initialization
3. `src/services/flashcard_generator.py` - Core AI service

## Tasks

### Task 1: Create Pydantic Schema Models (Wave 1)

**Goal:** Define structured output schema using Pydantic for type-safe API responses.

**Actions:**
1. Create `src/models/schemas.py`
2. Import Pydantic BaseModel and List type
3. Define `FlashcardPair` model:
   - `question: str` - The question to ask
   - `answer: str` - The answer/explanation
4. Define `FlashcardSet` model:
   - `topic: str` - Topic name for the deck
   - `flashcards: List[FlashcardPair]` - List of 10 Q&A pairs
   - Optional: `metadata: dict` for future extensibility

**Student Learning Note:**
Pydantic models serve as both data validation and JSON schema definition. When passed to Anthropic's structured outputs API, they guarantee the response will match this exact structure.

**Code Pattern:**
```python
from pydantic import BaseModel, Field
from typing import List

class FlashcardPair(BaseModel):
    question: str = Field(description="Question testing understanding")
    answer: str = Field(description="Detailed answer with explanation")

class FlashcardSet(BaseModel):
    topic: str = Field(description="Topic name for the flashcard deck")
    flashcards: List[FlashcardPair] = Field(description="List of 10 question-answer pairs")
```

**Verification:**
- File created at `src/models/schemas.py`
- Can import: `from src.models.schemas import FlashcardPair, FlashcardSet`
- Pydantic validates field types correctly

**Commit Message:**
```
feat(models): add Pydantic schemas for AI flashcard generation

- Define FlashcardPair model (question, answer)
- Define FlashcardSet model (topic, list of 10 pairs)
- Use Field descriptions for better structured output quality

These schemas enable type-safe structured outputs from Claude API.
```

---

### Task 2: Create FlashcardGenerator Service (Wave 2)

**Goal:** Build core service class that uses Anthropic structured outputs to generate flashcards.

**Actions:**
1. Create `src/services/__init__.py` (empty for now)
2. Create `src/services/flashcard_generator.py`
3. Import dependencies:
   - `from anthropic import Anthropic`
   - `from src.config import Config`
   - `from src.models.schemas import FlashcardSet, FlashcardPair`
4. Create `FlashcardGenerator` class with:
   - `__init__()`: Initialize Anthropic client with API key
   - `generate_flashcards(notes: str, topic: str) -> FlashcardSet`: Main generation method
5. Implement generation logic:
   - Construct educational prompt (see research findings)
   - Call `client.beta.messages.parse()` with:
     - model: "claude-sonnet-4-5-20250929"
     - max_tokens: 2048
     - messages: user prompt with notes
     - response_model: FlashcardSet (Pydantic schema)
   - Add beta header: `"anthropic-beta": "structured-outputs-2025-11-13"`
   - Return parsed FlashcardSet

**Prompt Engineering (from research):**
The prompt should:
- Explicitly request 10 flashcards
- Emphasize active recall (test understanding, not memorization)
- Request questions that require explanation (avoid yes/no)
- Focus on key concepts from the notes
- Request detailed answers that reinforce learning

**Code Pattern:**
```python
class FlashcardGenerator:
    def __init__(self):
        self.client = Anthropic(api_key=Config.ANTHROPIC_API_KEY)

    def generate_flashcards(self, notes: str, topic: str) -> FlashcardSet:
        """Generate 10 flashcards from study notes using Claude."""
        prompt = f"""You are an expert educator creating flashcards for active recall study.

Topic: {topic}

Study Notes:
{notes}

Generate exactly 10 flashcards that:
1. Test understanding, not memorization
2. Use questions requiring explanation (avoid yes/no questions)
3. Focus on key concepts from the notes
4. Include detailed answers that reinforce learning
5. Progress from fundamental to more complex concepts

Each flashcard should help the student recall and understand the material."""

        response = self.client.beta.messages.parse(
            model="claude-sonnet-4-5-20250929",
            max_tokens=2048,
            messages=[{"role": "user", "content": prompt}],
            response_model=FlashcardSet,
        )

        return response.parsed
```

**Student Learning Notes:**
- `client.beta.messages.parse()` is the structured outputs API
- `response_model=FlashcardSet` tells Claude to match our Pydantic schema
- The SDK automatically adds the beta header
- `response.parsed` gives us a validated FlashcardSet object

**Verification:**
- Files created: `src/services/__init__.py`, `src/services/flashcard_generator.py`
- Can instantiate: `generator = FlashcardGenerator()`
- Test generation with sample notes:
  ```python
  from src.services.flashcard_generator import FlashcardGenerator

  generator = FlashcardGenerator()
  notes = "Flask is a micro web framework. It uses decorators for routing. Jinja2 is the template engine."
  result = generator.generate_flashcards(notes, "Flask Basics")

  print(f"Topic: {result.topic}")
  print(f"Generated {len(result.flashcards)} flashcards")
  print(f"First Q: {result.flashcards[0].question}")
  print(f"First A: {result.flashcards[0].answer}")
  ```
- Verify: Returns FlashcardSet with exactly 10 FlashcardPair objects
- Verify: Questions test understanding (not yes/no format)
- Verify: Answers are detailed and educational

**Commit Message:**
```
feat(services): add FlashcardGenerator with structured outputs

- Initialize Anthropic client with API key from config
- Use client.beta.messages.parse() for type-safe responses
- Educational prompt emphasizes active recall and understanding
- Generate exactly 10 Q&A pairs using Claude Sonnet 4.5
- Structured outputs guarantee schema compliance

No retry logic yet - that comes in next plan (02-02).
```

## Verification

After completing both tasks:

1. **Schema validation:**
   - Import schemas work: `from src.models.schemas import FlashcardSet, FlashcardPair`
   - Pydantic validation works (try passing invalid data)

2. **Generation test:**
   - Create test script that calls `generate_flashcards()` with sample notes
   - Verify returns FlashcardSet with 10 pairs
   - Inspect quality: questions test understanding, answers are detailed
   - Print JSON to see structure: `print(result.model_dump_json(indent=2))`

3. **API connectivity:**
   - Confirm API key loads from environment
   - Successful API call returns 200
   - Structured output matches schema exactly

4. **No errors for:**
   - Missing API key (should fail fast with clear error)
   - Invalid schema (Pydantic validation)
   - API errors (will handle in Plan 02-02)

## Success Criteria

- [ ] `src/models/schemas.py` created with FlashcardPair and FlashcardSet models
- [ ] `src/services/flashcard_generator.py` created with FlashcardGenerator class
- [ ] Can generate 10 flashcards from sample notes
- [ ] Questions test understanding (not yes/no)
- [ ] Answers are detailed and educational
- [ ] Structured outputs guarantee schema compliance (100% valid JSON)
- [ ] API key loads from environment correctly
- [ ] Test script demonstrates successful generation
- [ ] 2 git commits (Task 1: schemas, Task 2: generator)

## Output

**Deliverables:**
1. Pydantic schema models (`src/models/schemas.py`)
2. FlashcardGenerator service (`src/services/flashcard_generator.py`)
3. Test script showing successful generation
4. 2 atomic git commits

**Ready for Plan 02-02:**
- Core generation works reliably for valid inputs
- Error handling and retry logic (next plan)
- Database integration (next plan)

**Educational Value:**
Student learns:
- Structured outputs eliminate JSON parsing bugs
- Pydantic provides type safety and validation
- Prompt engineering impacts output quality
- SDK handles authentication and headers automatically

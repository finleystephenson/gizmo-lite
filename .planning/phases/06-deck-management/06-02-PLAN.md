---
phase: 06-deck-management
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: [src/routes/main.py, src/templates/stats.html, src/templates/decks.html, src/models/flashcard.py]
autonomous: false
---

<objective>
Create statistics dashboard showing study progress and performance metrics.

Purpose: Help students track their learning progress across all decks.
Output: Statistics page with cards studied, success rates, last studied, and streaks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Database already tracks these fields per flashcard
@src/models/flashcard.py

# Need to aggregate statistics
@src/models/deck.py

# Routes and templates
@src/routes/main.py
@src/templates/base.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add statistics aggregation methods to models</name>
  <files>src/models/flashcard.py, src/models/deck.py</files>
  <action>
**Add to Flashcard model:**
```python
@staticmethod
def get_deck_stats(deck_id):
    """
    Get aggregated statistics for a deck.

    Returns:
        dict: {
            'total_cards': int,
            'total_studied': int (sum of studied_count),
            'total_correct': int (sum of success_count),
            'success_rate': float (0-100 percentage),
            'last_studied': float or None (most recent last_studied timestamp),
            'avg_streak': float (average streak across cards)
        }
    """
```
Query should:
- COUNT(*) for total_cards
- SUM(studied_count) for total_studied
- SUM(success_count) for total_correct
- Calculate success_rate = (total_correct / total_studied) * 100 if total_studied > 0
- MAX(last_studied) for last_studied
- AVG(streak) for avg_streak

**Add to Deck model:**
```python
@staticmethod
def get_all_with_stats():
    """Get all decks with their statistics."""
```
Returns list of decks, each enriched with stats from Flashcard.get_deck_stats().

**Add overall stats method:**
```python
@staticmethod
def get_overall_stats():
    """
    Get overall statistics across all decks.

    Returns:
        dict: {
            'total_decks': int,
            'total_cards': int,
            'total_studied': int,
            'total_correct': int,
            'success_rate': float,
            'last_studied': float or None
        }
    """
```
  </action>
  <verify>
Test in Python shell:
```python
from src.models.flashcard import Flashcard
from src.models.deck import Deck
print(Flashcard.get_deck_stats(10))  # Use a deck with study history
print(Deck.get_overall_stats())
```
  </verify>
  <done>Statistics aggregation methods return correct data.</done>
</task>

<task type="auto">
  <name>Task 2: Create statistics page template and route</name>
  <files>src/routes/main.py, src/templates/stats.html, src/templates/base.html</files>
  <action>
**Add route in main.py:**
```python
@main.route('/stats')
def statistics():
    """Display statistics dashboard."""
```
- Call `Deck.get_all_with_stats()` for per-deck stats
- Call `Deck.get_overall_stats()` for overall summary
- Format timestamps to human-readable dates (like decks page)
- Pass to template

**Create stats.html template:**
Layout:
1. **Overall Summary Card** (top):
   - Total decks count
   - Total cards studied (lifetime)
   - Overall success rate (percentage with color: green >70%, yellow 50-70%, red <50%)
   - Last study session (formatted date or "Never")

2. **Per-Deck Statistics Table:**
   - Columns: Deck Name, Cards, Times Studied, Success Rate, Last Studied, Avg Streak
   - Sortable by clicking headers (optional, can skip for v1)
   - Each row links to study that deck
   - Success rate colored: green >70%, yellow 50-70%, red <50%
   - "Never" if not studied yet

3. **Empty State:**
   - If no decks: "No statistics yet. Create some decks and start studying!"
   - Link to create deck

**Add nav link in base.html:**
Add "Statistics" link next to "My Decks" in header navigation.
  </action>
  <verify>
Navigate to /stats and verify:
- Overall summary shows correct totals
- Per-deck table shows all decks with stats
- Success rates colored appropriately
- Dates formatted nicely
  </verify>
  <done>Statistics dashboard displays all metrics with proper formatting.</done>
</task>

<task type="auto">
  <name>Task 3: Add quick stats to decks page</name>
  <files>src/routes/main.py, src/templates/decks.html</files>
  <action>
**Update /decks route:**
Use `Deck.get_all_with_stats()` instead of `Deck.get_all()` to include stats.

**Update decks.html:**
Add study metrics below each deck name:
- Show "Studied X times" if studied_count > 0
- Show "Success rate: X%" if studied
- Show "Last studied: {date}" if studied
- Gray out text for unread decks: "Not studied yet"

**Layout:** Keep existing card structure, add stats below the card count line.
  </action>
  <verify>
Navigate to /decks and verify:
- Decks with study history show stats
- Decks without study history show "Not studied yet"
- Stats update after a study session
  </verify>
  <done>Deck cards show quick study statistics.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Statistics dashboard and deck stats display</what-built>
  <how-to-verify>
1. Run Flask: `cd ~/Expanza_Gary_Test && FLASK_APP=src.app flask run --port 5001`
2. Visit http://localhost:5001/stats
3. **Verify overall summary:**
   - Total decks count matches /decks
   - Total studied count seems reasonable
   - Success rate is a percentage (not NaN or infinity)
4. **Verify per-deck table:**
   - All decks listed
   - Decks you've studied have non-zero stats
   - Success rates color-coded
   - Links work to study decks
5. **Verify decks page updates:**
   - Visit /decks
   - Each deck shows quick stats or "Not studied yet"
6. **Test after studying:**
   - Study a deck (mark some correct, some wrong)
   - Return to /stats
   - Numbers should have updated
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Statistics aggregation methods work correctly
- [ ] /stats page displays overall and per-deck stats
- [ ] Success rates color-coded appropriately
- [ ] Navigation link added to header
- [ ] Decks page shows quick stats
- [ ] Human verification passed
</verification>

<success_criteria>

- All tasks completed
- Statistics display all 4 required metrics (count, rate, timestamp, streak)
- Stats update after study sessions
- User approved dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/06-deck-management/06-02-SUMMARY.md`
</output>

---
phase: 05-spaced-repetition
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/templates/study.html, src/routes/main.py]
autonomous: false
---

<objective>
Implement simple re-queue system for cards marked "Needs Practice".

Purpose: Cards marked "Needs Practice" should reappear at the end of the session queue. Session only completes when ALL cards have been answered "Got it" at least once.
Output: Working spaced repetition within study sessions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work - study mode implementation
@.planning/phases/04-study-mode-ui/04-03-SUMMARY.md

# Current study flow implementation
@src/templates/study.html
@src/routes/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add re-queue logic to study.html JavaScript</name>
  <files>src/templates/study.html</files>
  <action>
Modify the JavaScript in study.html to implement card re-queuing:

**Current flow:**
- `cards` array loaded from server (fixed list)
- `currentIndex` tracks position
- When `currentIndex >= totalCards`, session ends

**New flow:**
1. Create a `cardQueue` array initialized with all card indices: `[0, 1, 2, ..., totalCards-1]`
2. Track which cards have been "mastered" (answered "Got it" at least once) using a Set: `masteredCards = new Set()`
3. In `gradeCard(success)`:
   - If `success === true`: Add card to masteredCards Set
   - If `success === false`: Re-queue the card by pushing its index to end of cardQueue
4. After grading, shift the next card from cardQueue
5. Session ends when: `cardQueue.length === 0` (no more cards to study)

**Key changes:**
- Replace `currentIndex++` with queue management
- Replace `currentIndex >= totalCards` check with `cardQueue.length === 0`
- `displayCard()` should use `cardQueue[0]` to get current card index
- Track attempts per card for statistics (increment each time card is shown)

**Variables to add:**
```javascript
let cardQueue = [...Array(totalCards).keys()];  // [0, 1, 2, ..., n-1]
const masteredCards = new Set();  // Cards that got "Got it!" at least once
const cardAttempts = {};  // { cardId: attemptCount }
```

**Modified gradeCard logic:**
```javascript
// Get current card from front of queue
const cardIndex = cardQueue.shift();
const card = cards[cardIndex];

// Track attempt
cardAttempts[card.id] = (cardAttempts[card.id] || 0) + 1;

// Grade and potentially re-queue
if (success) {
    masteredCards.add(card.id);
} else {
    // Re-queue at end if not mastered
    cardQueue.push(cardIndex);
}

// Check if session complete (all cards mastered and queue empty)
if (cardQueue.length === 0) {
    // Go to summary
} else {
    displayCard();
}
```

**Modified displayCard logic:**
```javascript
const cardIndex = cardQueue[0];  // Peek at front of queue
const card = cards[cardIndex];
// ... rest of display logic unchanged
```

Add educational comments explaining the re-queue algorithm.
  </action>
  <verify>
Open browser console, study a deck. When clicking "Needs Practice", that card should reappear later. Session should only end when all cards have "Got it" at least once.
  </verify>
  <done>
Cards marked "Needs Practice" re-appear at end of queue. Session ends only when all cards mastered.
  </done>
</task>

<task type="auto">
  <name>Task 2: Track card attempts in database</name>
  <files>src/routes/main.py</files>
  <action>
Update the grade endpoint to track attempt count:

**Current /study/{deck_id}/grade endpoint:**
- Calls `Flashcard.update_stats(card_id, success)`
- Updates studied_count, success_count, last_studied, streak

**Enhancement:**
The existing `Flashcard.update_stats()` already increments `studied_count` each time a card is graded. This is the "attempts" count we need.

Verify the current implementation is correct:
1. Read `src/models/flashcard.py` to confirm `update_stats()` increments `studied_count`
2. If not already tracking per-grade attempts, add increment

**Also update summary to include attempt data:**
Modify the summary page to show total attempts vs total cards (e.g., "Completed in 15 attempts for 10 cards").

In the summary route, calculate:
- `total_attempts = sum of all attempts from studyResults`
- Pass to template

In summary.html, display:
- Add "Total attempts: X" or "Attempts: X for Y cards"
  </action>
  <verify>
Study a deck, mark some cards "Needs Practice" multiple times. Check database that studied_count reflects all attempts. Summary shows attempt count.
  </verify>
  <done>
Database tracks all card attempts. Summary displays attempt statistics.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Spaced repetition re-queue system within study sessions</what-built>
  <how-to-verify>
1. Run Flask: `FLASK_APP=src.app flask run --port 5001`
2. Visit http://localhost:5001/decks
3. Click "Study Now" on any deck with 5+ cards
4. Test re-queue behavior:
   - Answer first 2-3 cards as "Got it!"
   - Answer next 2 cards as "Needs Practice"
   - Continue answering - the "Needs Practice" cards should reappear
   - Those cards should show up again at the end of the queue
5. Mark all cards "Got it!" (including the re-queued ones)
6. Session should end and show summary
7. Summary should show:
   - Total cards studied (original count)
   - Total attempts (should be > card count if you re-queued)
   - Success rate based on final "Got it" responses
8. Try again with ALL cards as "Needs Practice" first time through:
   - Cards should keep cycling until you mark each "Got it"
   - Session shouldn't end until every card is mastered

**What to confirm:**
- "Needs Practice" cards reappear at end of queue
- Session only ends when ALL cards have "Got it" at least once
- Attempt count tracked correctly
- No infinite loops (session eventually ends)
- Summary shows accurate statistics
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Flask app runs without errors
- [ ] "Needs Practice" cards re-queue at end of session
- [ ] Session ends only when all cards mastered
- [ ] Attempt count tracked in database
- [ ] Summary displays attempt statistics
- [ ] Human verification passed
</verification>

<success_criteria>

- All tasks completed
- Re-queue logic works correctly
- No infinite loops possible
- Statistics track attempts accurately
- User approved spaced repetition flow
</success_criteria>

<output>
After completion, create `.planning/phases/05-spaced-repetition/05-01-SUMMARY.md`
</output>
